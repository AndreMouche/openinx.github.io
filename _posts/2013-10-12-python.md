---
layout: post
title: "理解Python用类做装饰器的用法"
description: ""
category: python
tags: [python]
---

{% include JB/setup %}

首先看下面一段代码，看看调用app(a=34, b=35)的时候，调用过程是怎样的？

    class RequestClass(object):
        
        def __init__(self, a=1, b=2):
            print 'RequestClass.__init__(): a', a, 'b', b
            self.a = a
            self.b = b


    def print_args(*args, **kwargs):
        print 'print_args args:', args, 'kwargs', kwargs

        
    class wsgify(object):
        
        def __init__(self, func=None, request_cls=None):
            print 'wsgi.__init__(): func', func, 'request_cls', request_cls
            self.func = func 
            self.request_cls = request_cls 
        
        
        def __call__(self, req, *args):
            print 'wsgify.__call__(): req', req, 'args', args
            #return self.func
            return req
        

    class Application(object):
        
        @wsgify(func=print_args, request_cls=RequestClass)
        def __call__(self, **kw):
            print 'Application.__call__(self, *kw):', kw


    app = Application()
    app(a=34,b=35)

初看可能会比较困惑，但是看看下面的一个常见的python的装饰器的用法来理解。

    def deco(fn):
        def _do(*args):
            ret = fn(*args)
            return ret
        return _do

    @deco
    def good(a):
        '''_do = deco(good)
        _do(a)
        '''
        print 'helloworld'

    good(34)


### 理解第2段代码
第2块代码的good(34)这个方法的调用流程，很明显是:
+  _do = deco(fn), 调用deco(fn)方法，返回_do方法
+  _do(a), 将传入good方法的参数，传递给_do（a）
+  在_do方法里面调用good(a)


### 理解第1段代码
下面回到第1段代码:
首先看app=Application()实例化的时候，做了什么事情呢？
+ _wsgify = wsgify(func=print_args, request_cls=RequestClass)
+ 加载实例的`Application.__call__`方法时,会调用_wsgify的`__call__`来装饰`Application.__call__`方法。 
`app.__call__ = _wsgify.__call__(Application.__call__)`,  
按照`_wsgify.__call__`的实现，返回的是一个req对象,而这里req就是`app.__call__ `。

然后来看`app(a=34,b=35)`的调用流程:
+ 调用`app.__call__(a=34,b=35)` 

上述就是整个类装饰器的调用过程。
